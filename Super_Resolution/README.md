# Super Resolution Model 
---

## Overview (README.md is in progress.)

* NASA dataset compression source code (OpenCV, Python):
  - `compression.py`
    - generate 50% scaled images for training and testing data

* Model training source code (PyTorch, Python):
  - `data.py`
  - `dataset.py`
  - `model.py`
  - `main.py`
    - --upscale_factor should be 2, or you had better to modify crop_size according to your dataset
    - --train_datapath and --train_ds_datapath should be a path to the folder which contains raw images and images generated from `compression.py` respectively
    - Raw image name: xxx.png
    - Resized image name: xxx_s.png

* Inference and evaluation source code (PyTorch + PIL, Python):
  - `super_resolve.py`

* Inference and evaluation source code (ONNX Runtime + OpenCV, Python):
  - `super_onnx.py`
    - you can modify line 80 to change image path generated by cpp_onnx/super_cpp.cpp

* Inference and output source code (ONNX Runtime + OpenCV, C++):
  - `cpp_onnx/super_cpp.cpp`
    - output to ../output_cpp.png by default

* Model file:
  - `model_epoch_200.pth`
  - `nasa_srmodel.onnx`

## Environment and Sample Commands
### Environment (Python)
  * PyTorch 1.2 docker container, e.g.
    ```
    docker run -it  --gpus all  --name nasa_test -v /home/xxx/NASA2019_Project/Super_Resolution :/workspace pytorch/pytorch:1.2-cuda10.0-cudnn7-runtime /bin/bash
    ```
  * OpenCV installation (Python)
    ```
    apt update
    apt install -y libglib2.0-0 libsm6 libxrender1 libxext-dev
    pip install opencv-python
    ```
  * ONNX Runtime installation (Python)
    ```
    pip install onnxruntime onnx
    ```

### Training and Inference Commands (Python)
  * Training, e.g.
  ```
  python3 main.py --upscale_factor 2 --batchSize 4 --testBatchSize 100 --nEpochs 200 --lr 0.001 --cuda  --train_datapath NASA_MSLMHL_0009_EXCERPT/train/images_o --test_datapath NASA_MSLMHL_0009_EXCERPT/test/images_o --train_ds_datapath NASA_MSLMHL_0009_EXCERPT/train/images_s --test_ds_datapath NASA_MSLMHL_0009_EXCERPT/test/images_s
  ```
  * Inference, evaluation and export ONNX (PyTorch + PIL, Python), e.g.
  ```
  python3 super_resolve.py --input_image NASA_MSLMHL_0009_EXCERPT/test/images_s/0046MH0000100010100131I01_DRLX_s.png --model model_epoch_200.pth --output_filename out.png  --psnr_target NASA_MSLMHL_0009_EXCERPT/test/images_o/0046MH0000100010100131I01_DRLX.png --cuda -c --onnx_export nasa_srmodel.onnx
  ```
  * Inference and evaluation (ONNX Runtime + OpenCV, Python), e.g.
  ```
  python3 super_onnx.py --input_image NASA_MSLMHL_0009_EXCERPT/test/images_s/0046MH0000100010100131I01_DRLX_s.png  --model nasa_srmodel.onnx --output_filename out.png  --psnr_target  NASA_MSLMHL_0009_EXCERPT/test/images_o/0046MH0000100010100131I01_DRLX.png -c
  ```

### Environment (C++, ONNX Runtime and OpenCV)
  * docker image on AI-box (or [build the image by yourself](https://github.com/microsoft/onnxruntime/tree/master/tools/ci_build/github/linux/docker))
  ```
  docker run --name nasa_onnx -u 0 -v /home/xxx/NASA2019_Project/Super_Resolution :/workspace -it onnxruntime_dev /bin/bash
  cd /workspace
  ```
  * OpenCV installation (C++)
  ```
  apt update
  apt install -y build-essential git libgtk2.0-dev pkg-config libavcodec-dev libavformat-dev libswscale-dev libtbb2 libtbb-dev libjpeg-dev libpng-dev libtiff-dev libjasper-dev libdc1394-22-dev libopencv-dev
  ```
  * Build ONNX Runtime C++ API
  ```
  git clone https://github.com/microsoft/onnxruntime.git
  cd onnxruntime
  ./build.sh --config RelWithDebInfo --build_shared_lib --parallel
  ```
  * Copy onnxruntime/build/Linux/RelWithDebInfo/libonnxruntime.so.0.5.0 to cpp_onnx/


### Compile and Inference Commands (C++)
* Inference and output image (ONNX Runtime + OpenCV, C++)
* Compile:
```
cd /workspace/cpp_onnx
g++ -std=c++11  `pkg-config --cflags opencv` super_cpp.cpp `pkg-config --libs opencv` -o test -L/workspace/onnxruntime/onnxruntime/build/Linux/RelWithDebInfo/ -I/workspace/onnxruntime/onnxruntime/include/onnxruntime/core/session -lonnxruntime
```
* Inference and Output:
    
LD_PRELOAD=./libonnxruntime.so.0.5.0 ./test [INPUT_IMAGE] [OUTPUT_PATH] [ONNX_MODEL]
```
LD_PRELOAD=./libonnxruntime.so.0.5.0 ./test ../NASA_MSLMHL_0009_EXCERPT/test/images_s/0046MH0000090010100121I01_DRCX_s.png ../output_cpp.png ../nasa_srmodel.onnx
```
